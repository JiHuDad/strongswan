# extsock Plugin Google Test Suite
# CMake ë¹Œë“œ ì‹œìŠ¤í…œ for Google Test Migration

cmake_minimum_required(VERSION 3.14)
project(extsock_gtest LANGUAGES CXX C)

# C++ í‘œì¤€ ì„¤ì •
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# ì»´íŒŒì¼ ì˜µì…˜
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -g -O0")
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -g -O0")

# Google Test ì„¤ì •
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/v1.14.0.zip
  DOWNLOAD_EXTRACT_TIMESTAMP true
)

# Google Testë¥¼ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ì²˜ë¦¬í•˜ì—¬ ê²½ê³  ì–µì œ
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

# ========================================
# Real Plugin Integration Configuration  
# ========================================

# Phase ì„¤ì • (ê¸°ë³¸ê°’: 1)
if(NOT DEFINED REAL_PLUGIN_PHASE)
    set(REAL_PLUGIN_PHASE 1)
endif()

message(STATUS "ğŸš€ Real Plugin Test Phase: ${REAL_PLUGIN_PHASE}")

# extsock Plugin ê²½ë¡œ ì„¤ì •
set(EXTSOCK_PLUGIN_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../..")
set(EXTSOCK_PLUGIN_LA "${EXTSOCK_PLUGIN_DIR}/libstrongswan-extsock.la")

# strongSwan ë¼ì´ë¸ŒëŸ¬ë¦¬ ê²½ë¡œ (ìë™ íƒì§€)
execute_process(
    COMMAND pkg-config --variable=plugindir strongswan
    OUTPUT_VARIABLE STRONGSWAN_PLUGIN_DIR
    OUTPUT_STRIP_TRAILING_WHITESPACE
    ERROR_QUIET
)

if(NOT STRONGSWAN_PLUGIN_DIR)
    set(STRONGSWAN_PLUGIN_DIR "/usr/local/lib/ipsec/plugins")
endif()

message(STATUS "ğŸ“¦ strongSwan Plugin Directory: ${STRONGSWAN_PLUGIN_DIR}")

# strongSwan í—¤ë” ê²½ë¡œ
find_path(STRONGSWAN_INCLUDE_DIR
    NAMES library.h
    PATHS /usr/local/include/strongswan /usr/include/strongswan
    PATH_SUFFIXES libstrongswan
)

if(STRONGSWAN_INCLUDE_DIR)
    message(STATUS "âœ… strongSwan Headers: ${STRONGSWAN_INCLUDE_DIR}")
else()
    message(WARNING "âš ï¸  strongSwan headers not found - Real Plugin tests may fail")
endif()

# ê¸°ì¡´ ì¸í´ë£¨ë“œ ë””ë ‰í† ë¦¬ ì„¤ì •
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/..  # test ë””ë ‰í† ë¦¬
    ${CMAKE_CURRENT_SOURCE_DIR}/../..  # extsock ë””ë ‰í† ë¦¬
    ${CMAKE_CURRENT_SOURCE_DIR}/../../..  # plugins ë””ë ‰í† ë¦¬
    ${CMAKE_CURRENT_SOURCE_DIR}/../../../..  # libcharon ë””ë ‰í† ë¦¬
)

# strongSwan í—¤ë” ì¶”ê°€ (Phase 2+ì—ì„œ ì‚¬ìš©)
if(STRONGSWAN_INCLUDE_DIR AND REAL_PLUGIN_PHASE GREATER 1)
    include_directories(
        ${STRONGSWAN_INCLUDE_DIR}
        ${STRONGSWAN_INCLUDE_DIR}/../libcharon
        ${EXTSOCK_PLUGIN_DIR}
    )
endif()

# extsock í”ŒëŸ¬ê·¸ì¸ ì†ŒìŠ¤ íŒŒì¼ë“¤ (Phaseë³„ ê´€ë¦¬)
if(REAL_PLUGIN_PHASE GREATER 1)
    set(EXTSOCK_SOURCES
        # Phase 2+ì—ì„œ ì‹¤ì œ ì†ŒìŠ¤ ì—°ë™
        # ../common/extsock_errors.c
        # ../adapters/json/extsock_json_parser.c
    )
else()
    set(EXTSOCK_SOURCES
        # Phase 1ì—ì„œëŠ” ë¹„ì–´ìˆìŒ
    )
endif()

# í…ŒìŠ¤íŠ¸ ì¸í”„ë¼ ë¼ì´ë¸ŒëŸ¬ë¦¬
add_library(extsock_test_infrastructure
    # Mock í´ë˜ìŠ¤ë“¤
    infrastructure/mocks/MockStrongSwan.cpp
    infrastructure/mocks/MockJsonParser.cpp
    infrastructure/mocks/MockSocketAdapter.cpp
    
    # Fixture í´ë˜ìŠ¤ë“¤
    infrastructure/fixtures/ExtsockTestBase.cpp
    infrastructure/fixtures/IntegrationTestFixture.cpp
    
    # ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ë“¤ (í–¥í›„ ì¶”ê°€)
    # infrastructure/utils/TestDataFactory.cpp
)

target_link_libraries(extsock_test_infrastructure
    gtest
    gmock
    pthread
)

# Hello World í…ŒìŠ¤íŠ¸ (ì´ˆê¸° ì„¤ì • ê²€ì¦ìš©)
add_executable(hello_gtest_test
    infrastructure/hello_gtest_test.cpp
)

target_link_libraries(hello_gtest_test
    gtest_main
    extsock_test_infrastructure
)

# Mock Integration í…ŒìŠ¤íŠ¸ (Mock ì¸í”„ë¼ ê²€ì¦ìš©)
add_executable(mock_integration_test
    infrastructure/mock_integration_test.cpp
)

target_link_libraries(mock_integration_test
    gtest_main
    gmock_main
    extsock_test_infrastructure
)

# Unit Tests - Level 1 Pure + Level 2 Adapter Tests
set(UNIT_TEST_SOURCES
    # Level 1 Pure Tests
    src/unit/ExtsockErrorsTest.cpp
    src/unit/ExtsockTypesTest.cpp
    
    # Level 2 Adapter Tests
    src/unit/JsonParserTestSimple.cpp
    src/unit/SocketAdapterTest.cpp
    src/unit/StrongswanAdapterTest.cpp
    
    # unit/domain/ConfigEntityTest.cpp
    # unit/domain/ConfigUsecaseTest.cpp
)

# C Wrapper ì†ŒìŠ¤ íŒŒì¼ë“¤ (Pure êµ¬í˜„)
set(C_WRAPPER_SOURCES
    src/c_wrappers/extsock_errors_pure.c
)

add_executable(unit_tests ${UNIT_TEST_SOURCES} ${C_WRAPPER_SOURCES})

target_include_directories(unit_tests PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/include
    ${CMAKE_CURRENT_SOURCE_DIR}/include/c_wrappers
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

target_link_libraries(unit_tests
    gtest_main
    gmock_main
    extsock_test_infrastructure
)

# Integration Tests
# í˜„ì¬ëŠ” ë¹„ì–´ìˆìŒ - ë§ˆì´ê·¸ë ˆì´ì…˜ ì§„í–‰í•˜ë©´ì„œ ì¶”ê°€

# set(INTEGRATION_TEST_SOURCES  
#     integration/WorkflowIntegrationTest.cpp
#     integration/PluginLifecycleTest.cpp
#     integration/FailoverIntegrationTest.cpp
# )

# add_executable(integration_tests ${INTEGRATION_TEST_SOURCES})
# target_link_libraries(integration_tests
#     gtest_main  
#     gmock_main
#     extsock_test_infrastructure
# )

# Performance Tests (ì„ íƒì‚¬í•­)
# Google Benchmark ì‚¬ìš© ì‹œ í™œì„±í™”

# find_package(benchmark QUIET)
# if(benchmark_FOUND)
#     add_executable(performance_tests
#         performance/BenchmarkTests.cpp
#         performance/StressTests.cpp
#     )
#     target_link_libraries(performance_tests
#         benchmark::benchmark
#         extsock_test_infrastructure
#     )
# endif()

# CTest í™œì„±í™”
enable_testing()

# í…ŒìŠ¤íŠ¸ ë“±ë¡
add_test(NAME hello_gtest_test COMMAND hello_gtest_test)
add_test(NAME mock_integration_test COMMAND mock_integration_test)
add_test(NAME unit_tests COMMAND unit_tests)
# add_test(NAME integration_tests COMMAND integration_tests)

# Google Test Discovery (CMake 3.10+)
include(GoogleTest)
gtest_discover_tests(hello_gtest_test)

# ì»¤ìŠ¤í…€ íƒ€ê²Ÿë“¤

# ëª¨ë“  í…ŒìŠ¤íŠ¸ ë¹Œë“œ
add_custom_target(build_all_tests
    DEPENDS hello_gtest_test mock_integration_test unit_tests
    # integration_tests
    COMMENT "Building all Google Test executables"
)

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ìƒì„¸ ì¶œë ¥)
add_custom_target(run_tests_verbose
    COMMAND ${CMAKE_CTEST_COMMAND} --verbose
    DEPENDS build_all_tests
    COMMENT "Running all tests with verbose output"
)

# XML ì¶œë ¥ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (CI/CDìš©)
add_custom_target(run_tests_xml
    COMMAND hello_gtest_test --gtest_output=xml:hello_gtest_results.xml
    COMMAND mock_integration_test --gtest_output=xml:mock_integration_results.xml
    COMMAND unit_tests --gtest_output=xml:unit_test_results.xml
    # COMMAND integration_tests --gtest_output=xml:integration_test_results.xml
    DEPENDS build_all_tests  
    COMMENT "Running all tests with XML output for CI/CD"
)

# ========================================
# Real Plugin Tests Configuration
# ========================================

# Real Plugin ì†ŒìŠ¤ íŒŒì¼ë“¤ (Phaseë³„)
if(REAL_PLUGIN_PHASE EQUAL 1)
    set(REAL_PLUGIN_SOURCES
        src/real_integration/StrongSwanTestEnvironment.cpp
        src/real_integration/RealPluginTestBase.cpp  
        src/real_integration/RealExtsockErrorsTest.cpp
        src/real_integration/strongswan_test_helpers.cpp
        src/real_integration/TestMain.cpp
    )
elseif(REAL_PLUGIN_PHASE EQUAL 2)
    set(REAL_PLUGIN_SOURCES
        src/real_integration/StrongSwanTestEnvironment.cpp
        src/real_integration/RealPluginTestBase.cpp
        src/real_integration/RealExtsockErrorsTest.cpp
        src/real_integration/strongswan_mock_api.cpp
        src/real_integration/strongswan_test_helpers.cpp
        src/real_integration/TestMain.cpp
        # Future Phase 2 tests (placeholder)
        # src/real_integration/RealJsonParserTest.cpp
        # src/real_integration/RealSocketAdapterTest.cpp
    )
elseif(REAL_PLUGIN_PHASE EQUAL 4)
    # Phase 4: ì‹¤ì œ .so ë¼ì´ë¸ŒëŸ¬ë¦¬ ì§ì ‘ í˜¸ì¶œ
    set(REAL_PLUGIN_SOURCES
        src/real_integration/StrongSwanTestEnvironment.cpp
        src/real_integration/RealPluginTestBase.cpp
        src/real_integration/RealExtsockErrorsTest.cpp
        src/real_integration/RealExtsockFunctionTest.cpp
        src/real_integration/RealEndToEndTest.cpp
        src/real_integration/RealPluginLoader.cpp
        src/real_integration/strongswan_mock_api.cpp
        src/real_integration/strongswan_test_helpers.cpp
        src/real_integration/TestMain.cpp
        # Phase 4 íŠ¹í™” í…ŒìŠ¤íŠ¸ë“¤
        src/real_integration/RealDirectLibraryTest.cpp
        # Phase 4: strongSwan Mock Library í¬í•¨í•˜ì§€ ì•ŠìŒ (ë³„ë„ íƒ€ê²Ÿìœ¼ë¡œ ë¶„ë¦¬)
    )
else()
    # Phase 3+: ëª¨ë“  Real Plugin í…ŒìŠ¤íŠ¸ í¬í•¨
    set(REAL_PLUGIN_SOURCES
        src/real_integration/StrongSwanTestEnvironment.cpp
        src/real_integration/RealPluginTestBase.cpp
        src/real_integration/RealExtsockErrorsTest.cpp
        src/real_integration/RealExtsockFunctionTest.cpp
        src/real_integration/RealEndToEndTest.cpp
        src/real_integration/strongswan_mock_api.cpp
        src/real_integration/strongswan_test_helpers.cpp
        src/real_integration/TestMain.cpp
        # Future Phase 3+ tests
        # src/real_integration/RealJsonParserTest.cpp
        # src/real_integration/RealSocketAdapterTest.cpp  
        # src/real_integration/RealPluginLifecycleTest.cpp
    )
endif()

# Real Plugin í…ŒìŠ¤íŠ¸ ì‹¤í–‰íŒŒì¼ (Phase 1+)
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/src/real_integration/TestMain.cpp")
    add_executable(real_plugin_tests ${REAL_PLUGIN_SOURCES})

    # í—¤ë” ê²½ë¡œ ì„¤ì •
    target_include_directories(real_plugin_tests PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${CMAKE_CURRENT_SOURCE_DIR}/include/real_integration
    )

    # ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬ (Phaseë³„)
    if(REAL_PLUGIN_PHASE EQUAL 1)
        # Phase 1: ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ (strongSwan ì—†ì´)
        target_link_libraries(real_plugin_tests
            gtest_main
            gmock_main
            extsock_test_infrastructure
            cjson
            pthread
            dl
        )
    elseif(REAL_PLUGIN_PHASE EQUAL 4)
        # Phase 4: strongSwan Mock Library (static + ì»´íŒŒì¼ íƒ€ì„ ë§í‚¹)
        set(STRONGSWAN_MOCK_SOURCES
            src/real_integration/StrongSwanMockLibrary.cpp
        )
        
        add_library(strongswan_mock_library STATIC ${STRONGSWAN_MOCK_SOURCES})
        target_include_directories(strongswan_mock_library PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/include/real_integration
        )
        
        # Phase 4: ì‹¤ì œ .so ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë”©
        target_link_libraries(real_plugin_tests
            gtest_main
            gmock_main
            extsock_test_infrastructure
            strongswan_mock_library  # strongSwan Mock Library ë§í¬
            cjson
            pthread
            dl  # dlopen/dlsymë¥¼ ìœ„í•´ í•„ìˆ˜
        )
        
        # Phase 4: Mock ì‹¬ë³¼ë“¤ì„ dynamic loaderì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ export
        target_link_options(real_plugin_tests PRIVATE "-Wl,--export-dynamic")
        
        # Phase 4 ì „ìš© ì»´íŒŒì¼ ì˜µì…˜
        target_compile_definitions(real_plugin_tests PRIVATE
            -DUSE_REAL_LIBRARY_LOADING=1
        )
        
        # Phase 4: ë§ì»¤ ì˜µì…˜ - Mock ì‹¬ë³¼ë“¤ì„ ì „ì—­ì ìœ¼ë¡œ export ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
        
        # .so íŒŒì¼ ê²½ë¡œë¥¼ ì»´íŒŒì¼ íƒ€ì„ì— ì •ì˜
        get_filename_component(EXTSOCK_SO_PATH 
            "${CMAKE_CURRENT_SOURCE_DIR}/../../../extsock/.libs/libstrongswan-extsock.so" 
            ABSOLUTE)
        target_compile_definitions(real_plugin_tests PRIVATE
            -DEXTSOCK_LIBRARY_PATH="${EXTSOCK_SO_PATH}"
        )
        
        message(STATUS "ğŸ“š Phase 4: Will load library from ${EXTSOCK_SO_PATH}")
    else()
        # Phase 2-3: strongSwan ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
        target_link_libraries(real_plugin_tests
            gtest_main
            gmock_main
            extsock_test_infrastructure
            cjson
            pthread
            dl
        )
    endif()

    # ì»´íŒŒì¼ëŸ¬ í”Œë˜ê·¸
    target_compile_definitions(real_plugin_tests PRIVATE
        -DUSE_REAL_PLUGIN=1
        -DSTRONGSWAN_TEST_MODE=1
        -DREAL_PLUGIN_PHASE=${REAL_PLUGIN_PHASE}
    )

    # í…ŒìŠ¤íŠ¸ ë“±ë¡
    add_test(NAME real_plugin_tests COMMAND real_plugin_tests)

    message(STATUS "âœ… Real Plugin Tests configured for Phase ${REAL_PLUGIN_PHASE}")
else()
    message(STATUS "â³ Real Plugin Tests source not found - will be created during implementation")
endif()

# CI ì „ìš© Real Plugin Tests (ë¹ ë¥¸ ê²€ì¦)
if(TARGET real_plugin_tests)
    add_custom_target(ci_real_tests
        COMMAND real_plugin_tests --gtest_filter="-*EndToEnd*:*Performance*"
        DEPENDS real_plugin_tests
        COMMENT "Running Real Plugin Tests for CI (excluding long-running tests)"
    )

    # Full Real Plugin Tests (nightly buildìš©)
    add_custom_target(full_real_tests  
        COMMAND real_plugin_tests
        DEPENDS real_plugin_tests
        COMMENT "Running Full Real Plugin Tests (including End-to-End tests)"
    )
endif()

# ì½”ë“œ ì»¤ë²„ë¦¬ì§€ (gcov/lcov í•„ìš”)
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    add_custom_target(coverage
        COMMAND lcov --capture --directory . --output-file coverage.info
        COMMAND lcov --remove coverage.info '/usr/*' --output-file coverage.info
        COMMAND lcov --remove coverage.info '*/_deps/*' --output-file coverage.info  
        COMMAND genhtml coverage.info --output-directory coverage_report
        DEPENDS run_tests_verbose
        COMMENT "Generating code coverage report"
    )
    
    # Real Plugin ì»¤ë²„ë¦¬ì§€ (ë³„ë„)
    if(TARGET real_plugin_tests)
        add_custom_target(coverage_real
            COMMAND lcov --capture --directory . --output-file coverage_real.info
            COMMAND lcov --remove coverage_real.info '/usr/*' --output-file coverage_real.info
            COMMAND lcov --remove coverage_real.info '*/_deps/*' --output-file coverage_real.info  
            COMMAND genhtml coverage_real.info --output-directory coverage_real_report
            DEPENDS full_real_tests
            COMMENT "Generating Real Plugin code coverage report"
        )
    endif()
endif()

# ì •ë¦¬ íƒ€ê²Ÿ
add_custom_target(clean_gtest
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CMAKE_BINARY_DIR}/CMakeFiles
    COMMAND ${CMAKE_COMMAND} -E remove *.xml
    COMMAND ${CMAKE_COMMAND} -E remove_directory coverage_report
    COMMAND ${CMAKE_COMMAND} -E remove coverage.info
    COMMENT "Cleaning Google Test build artifacts"
)

# ì„¤ì¹˜ íƒ€ê²Ÿ (ì„ íƒì‚¬í•­)
# install(TARGETS hello_gtest_test DESTINATION bin)

# íŒ¨í‚¤ì§• ì„¤ì • (ì„ íƒì‚¬í•­) 
# set(CPACK_PROJECT_NAME ${PROJECT_NAME})
# set(CPACK_PROJECT_VERSION ${PROJECT_VERSION})
# include(CPack)